pipeline {
    agent { label 'docker-agent' }

    environment {
        TAG = "${env.BUILD_NUMBER}"
        APP_DIR = "reddit-clone-k8s-ingress-master"
        SONAR_TOKEN = credentials('sonarqube-token')
    }
    stages {
        stage('Setup Environment') {
            steps {
                script {
                    // 1. Clean the branch name to be Docker-compatible. For example:
                    //    feature/sonarTest  --->  feature-sonartest
                    def cleanBranch = env.BRANCH_NAME.toLowerCase().replaceAll('/', '-')
                    
                    // 2. Define image and container names based on the cleaned branch name
                    env.IMAGE_NAME = "reddit-clone-${cleanBranch}"
                    env.CONTAINER_NAME = "reddit-app-${cleanBranch}"
                    // 3. Set host port based on whether it's the main branch or not
                    env.HOST_PORT = (env.BRANCH_NAME == 'main') ? "3000" : "3001"
                    
                    echo "Configuring deploy in port: ${env.HOST_PORT}"
                    echo "Original Branch Name: ${env.BRANCH_NAME}"
                    echo "Docker Fixed Name: ${env.IMAGE_NAME}"
                }
            }
        }

        stage('Code Analysis (SonarQube)') {
            steps {
                script {
                    echo "Starting Code Analysis..."
                    dir(APP_DIR) {
                        sh """
                            docker run --rm \
                                --network=host \
                                -e SONAR_HOST_URL=http://10.0.1.5:9000 \
                                -e SONAR_TOKEN=\$SONAR_TOKEN \
                                -v "\$(pwd):/usr/src" \
                                sonarsource/sonar-scanner-cli \
                                -Dsonar.projectKey=reddit-clone \
                                -Dsonar.sources=. \
                                -Dsonar.exclusions=**/node_modules/**,**/dist/**
                        """
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Reddit Clone Image: ${env.IMAGE_NAME}"
                    dir(APP_DIR) {
                        sh "docker build -t ${env.IMAGE_NAME} ."
                    }
                }
            }
        }

        stage('Deploy App') {
            steps {
                script {
                    echo "Deploying Reddit Clone container: ${env.CONTAINER_NAME}"
                    
                    // 1. Cleanup old container (ignore errors if it doesn't exist)
                    sh "docker stop ${env.CONTAINER_NAME} || true"
                    sh "docker rm ${env.CONTAINER_NAME} || true"

                    // 2. Remove any container using the same port (3001 for non-main branches)
                    sh "docker ps -q --filter 'publish=3001' | xargs -r docker rm -f"

                    // 3. Run new container
                    sh "docker run -d -p 3000:3000 --name ${env.CONTAINER_NAME} ${env.IMAGE_NAME}"
                }
            }
        }

        stage('Verify') {
            steps {
                script {
                    echo "Verifying deployment..."
                    // Wait a bit for Node.js to start
                    sh "sleep 10" 
                    sh "curl -I http://localhost:3000"
                }
            }
        }
    }
}